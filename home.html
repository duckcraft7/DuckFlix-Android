<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: https://ssl.gstatic.com 'unsafe-inline' https://archive.org https://*.tmdb.org https://*.themoviedb.org https://*.ibb.co https://fonts.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; media-src *; img-src 'self' data: content: https:; connect-src *; font-src 'self' https://fonts.gstatic.com;">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="viewport" content="initial-scale=1, width=device-width, viewport-fit=cover, user-scalable=no">

    <title>DuckFlix - Catálogo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
</head>
<body class="home-page"> <button id="logout-button" class="focusable">Sair</button>

    <div id="catalog-content">
        <header class="main-header">
            <h1>DuckFlix</h1>
            <p>Seu cinema particular.</p>
        </header>

        <main id="catalog-main">
            <h2 class="loading-catalog">Carregando catálogo...</h2>
            </main>

        <footer class="main-footer">
            <p>&copy; 2025 DuckFlix. Feito com ❤️ para os amantes de cinema.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- VERIFICAÇÃO SIMPLES DE LOGIN (SEM FIREBASE) ---
            // Se não encontrar a flag, volta pro login
            if (localStorage.getItem('duckflix_isLoggedIn') !== 'true') {
                 console.log("Usuário não logado, redirecionando para index.html");
                window.location.replace('index.html');
                return; // Impede o resto do script de rodar
            }

            // --- REFERÊNCIAS ---
            const listaUrl = 'https://duckflix-lista.vercel.app/lista.json'; // Carrega lista local!
            const catalogMain = document.getElementById('catalog-main');
            const logoutButton = document.getElementById('logout-button');
            let allItems = [];
            let focusableElements = [];
            let currentFocusIndex = 0;

            // --- LÓGICA DE LOGOUT (SIMPLIFICADA) ---
            logoutButton.addEventListener('click', () => {
                localStorage.removeItem('duckflix_isLoggedIn'); // Remove a flag
                window.location.replace('index.html'); // Volta para o login
            });

            // --- LÓGICA DO CATÁLOGO (Igual à versão anterior) ---
            function fetchLista() {
                // (O código fetchLista, createMovieCard, createContinueWatchingSection permanecem iguais à versão anterior)
                 if (catalogMain.querySelector('.movie-section')) return;

                fetch(listaUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`Erro HTTP! status: ${response.status}`);
                        return response.json();
                     })
                    .then(data => {
                        catalogMain.innerHTML = '';
                        allItems = [];
                        data.categorias.forEach(cat => cat.items.forEach(item => {
                            // Adiciona ID se não existir (fallback)
                            if(!item.id) item.id = item.titulo.replace(/\s+/g, '').toLowerCase() + item.ano;
                            allItems.push(item);
                        }));


                        createContinueWatchingSection();

                        data.categorias.forEach(categoria => {
                            const section = document.createElement('section');
                            section.className = 'movie-section';
                            const title = document.createElement('h2');
                            title.textContent = categoria.titulo;
                            section.appendChild(title);
                            const grid = document.createElement('div');
                            grid.className = 'movie-grid';

                            categoria.items.forEach(item => {
                                const cardLink = createMovieCard(item);
                                cardLink.classList.add('focusable'); // Adiciona classe para navegação
                                grid.appendChild(cardLink);
                            });
                            section.appendChild(grid);
                            catalogMain.appendChild(section);
                        });
                        setupNavigation();
                    })
                    .catch(error => {
                         console.error('Erro ao carregar lista:', error);
                        catalogMain.innerHTML = '<h2>Erro ao carregar o catálogo. Verifique o arquivo lista.json.</h2>';
                    });
            }
             fetchLista(); // Chama o carregamento da lista

             // (As funções createMovieCard e createContinueWatchingSection são as mesmas da versão anterior)
             function createMovieCard(item, savedTime = 0) {
                const cardLink = document.createElement('a');
                cardLink.className = 'movie-card';
                let playerLink = `player.html?id=${item.id}&src=${encodeURIComponent(item.videolink)}&title=${encodeURIComponent(item.titulo)}`;
                if (savedTime > 0) playerLink += `&time=${savedTime}`;
                cardLink.href = playerLink;
                cardLink.innerHTML = `
                    <img src="${item.poster}" alt="Pôster de ${item.titulo}">
                    <div class="movie-info"><h3>${item.titulo}</h3><p>${item.ano}</p></div>
                    ${savedTime > 0 ? '<div class="progress-bar"><div class="progress-bar-inner" style="width: 50%;"></div></div>' : ''}`;
                return cardLink;
            }

            function createContinueWatchingSection() {
                const continueWatchingItems = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('progress_')) {
                        const itemId = key.replace('progress_', '');
                        const savedTime = parseFloat(localStorage.getItem(key));
                        const itemData = allItems.find(item => item.id === itemId);
                        if (itemData && savedTime > 0) {
                            continueWatchingItems.push({ ...itemData, savedTime });
                        }
                    }
                }
                if (continueWatchingItems.length > 0) {
                    const section = document.createElement('section');
                    section.className = 'movie-section continue-watching';
                    const title = document.createElement('h2');
                    title.textContent = 'Continuar Assistindo';
                    section.appendChild(title);
                    const grid = document.createElement('div');
                    grid.className = 'movie-grid';
                    continueWatchingItems.forEach(item => {
                        const cardLink = createMovieCard(item, item.savedTime);
                        cardLink.classList.add('focusable'); // Adiciona focusable aqui também
                        grid.appendChild(cardLink);
                    });
                    section.appendChild(grid);
                    catalogMain.prepend(section);
                }
            }


            // --- FUNÇÃO DE NAVEGAÇÃO (Igual à versão anterior, incluindo botão Sair) ---
             function setupNavigation() {
                focusableElements = Array.from(document.querySelectorAll('.focusable')); // Atualiza a lista de focáveis
                if (focusableElements.length === 0) return;
                // Encontra o índice do botão Sair, se ele existir
                const logoutButtonIndex = focusableElements.findIndex(el => el.id === 'logout-button');

                currentFocusIndex = 0; // Começa no primeiro elemento

                const setFocus = (index) => {
                    if (index < 0 || index >= focusableElements.length) return;
                    focusableElements[currentFocusIndex].classList.remove('focused');
                    currentFocusIndex = index;
                    focusableElements[currentFocusIndex].classList.add('focused');
                    if (focusableElements[currentFocusIndex].tagName === 'BUTTON' || focusableElements[currentFocusIndex].tagName === 'A') {
                       focusableElements[currentFocusIndex].focus();
                    }
                     if(focusableElements[currentFocusIndex].classList.contains('movie-card')) {
                        focusableElements[currentFocusIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
                     }
                };

                 // Adiciona listener para cliques/toques (para foco visual)
                 focusableElements.forEach((element, index) => {
                    if (element.classList.contains('movie-card')) {
                        element.addEventListener('click', (event) => {
                            setFocus(index);
                        });
                    }
                });

                document.addEventListener('keydown', (event) => {
                    event.preventDefault();
                    let nextFocusIndex = currentFocusIndex;
                    const currentElement = focusableElements[currentFocusIndex];

                    if (currentElement.classList.contains('movie-card')) {
                        const grid = currentElement.closest('.movie-grid');
                        if (grid) {
                            const gridStyle = window.getComputedStyle(grid);
                            const gridColumnCount = gridStyle.getPropertyValue('grid-template-columns').split(' ').length;
                            const cardIndexInGrid = Array.from(grid.children).indexOf(currentElement); // Posição dentro da grade atual

                            switch (event.key) {
                                case 'ArrowRight':
                                     const isLastInRow = (cardIndexInGrid + 1) % gridColumnCount === 0 || cardIndexInGrid === grid.children.length - 1;
                                    if (currentFocusIndex < focusableElements.length - 1 && focusableElements[currentFocusIndex+1].classList.contains('movie-card') && (!isLastInRow || gridColumnCount === 1)) {
                                         nextFocusIndex = currentFocusIndex + 1;
                                    } else if (logoutButtonIndex !== -1 && (isLastInRow || currentFocusIndex === focusableElements.length - 2)){ // Se for último da linha ou último card
                                        nextFocusIndex = logoutButtonIndex; // Pula para o botão Sair
                                    }
                                    break;
                                case 'ArrowLeft':
                                    const isFirstInRow = cardIndexInGrid % gridColumnCount === 0;
                                     if (currentFocusIndex > 0 && focusableElements[currentFocusIndex-1].classList.contains('movie-card') && (!isFirstInRow || gridColumnCount === 1)) {
                                          nextFocusIndex = currentFocusIndex - 1;
                                     }
                                    break;
                                case 'ArrowDown':
                                    let downIndex = currentFocusIndex + gridColumnCount;
                                     // Verifica se o alvo ainda é um card
                                    if (downIndex < focusableElements.length && focusableElements[downIndex].classList.contains('movie-card')) {
                                        nextFocusIndex = downIndex;
                                    } else if (logoutButtonIndex !== -1){ // Se não, tenta pular para o botão sair
                                        nextFocusIndex = logoutButtonIndex;
                                    }
                                    break;
                                case 'ArrowUp':
                                    let upIndex = currentFocusIndex - gridColumnCount;
                                     // Verifica se o alvo ainda é um card
                                    if (upIndex >= 0 && focusableElements[upIndex].classList.contains('movie-card')) {
                                        nextFocusIndex = upIndex;
                                    }
                                    // Opcional: pular para o botão Sair se subir demais?
                                    else if (logoutButtonIndex !== -1){
                                        nextFocusIndex = logoutButtonIndex;
                                    }
                                    break;
                                case 'Enter':
                                    const targetUrl = currentElement.getAttribute('href');
                                    if (targetUrl) window.location.href = targetUrl;
                                    return;
                            }
                        }
                    }
                    else if (currentElement.id === 'logout-button') {
                         switch (event.key) {
                            case 'ArrowLeft':
                            case 'ArrowUp':
                            case 'ArrowDown':
                                 // Tenta voltar para o último card focado ou o último card da lista
                                let lastCardIndex = -1;
                                for(let i = focusableElements.length - 1; i >= 0; i--){ // Busca de trás pra frente
                                    if(focusableElements[i].classList.contains('movie-card')){
                                        lastCardIndex = i;
                                        break;
                                    }
                                 }
                                 if(lastCardIndex !== -1) nextFocusIndex = lastCardIndex;
                                break;
                            case 'Enter':
                                 logoutButton.click();
                                 return;
                         }
                    }

                    if (nextFocusIndex !== currentFocusIndex) {
                        setFocus(nextFocusIndex);
                    }
                });

                setFocus(0);
                 if(focusableElements.length > 0 && focusableElements[0].classList.contains('movie-card')) {
                     focusableElements[0].scrollIntoView({ behavior: 'auto', block: 'nearest', inline: 'nearest' });
                 }
            } // Fim da função setupNavigation
        }); // Fim do DOMContentLoaded
    </script>
    <script src="cordova.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
