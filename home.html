<!DOCTYPE html>
<html lang="pt-br">
<head>
    <style>
        /* ...(Seus estilos + .focused + .progress-bar etc)... */

        /* ESTILO PARA O LOG NA TELA */
        #debug-log-on-screen {
            position: fixed; bottom: 5px; left: 5px; max-height: 100px; /* Limita altura */
            overflow-y: scroll; /* Adiciona rolagem se o log ficar grande */
            width: calc(100% - 10px); background-color: rgba(0,0,0,0.7); color: lime;
            font-family: monospace; font-size: 10px; z-index: 10000;
            padding: 5px; border: 1px solid lime; border-radius: 4px;
            pointer-events: none; /* Impede que ele bloqueie toques */
        }
    </style>
</head>
<body class="home-page">

    <div id="debug-log-on-screen">Iniciando Home...</div>

    <button id="logout-button" class="focusable hidden">Sair</button>

    <div id="catalog-content" class="hidden">
        </div>

    <div id="loading-indicator" class="loading-catalog">Verificando sessão...</div>

    <script>
        // --- FUNÇÃO PARA ESCREVER NO LOG NA TELA ---
        const logElement = document.getElementById('debug-log-on-screen');
        function logOnScreen(message) {
            console.log(message); // Mantém no console também
            if(logElement) {
                // Adiciona a nova mensagem no início e limita o tamanho
                logElement.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}<br>` + logElement.innerHTML.substring(0, 1000);
                 logElement.scrollTop = 0; // Mostra a mensagem mais recente
            }
        }
        // Captura erros globais e os mostra na tela
        window.onerror = function(message, source, lineno, colno, error) {
             logOnScreen(`ERRO GLOBAL: ${message} em ${source}:${lineno}`);
             if (error) console.error(error);
             return true; // Impede que o erro pare outros scripts (pode não funcionar sempre)
        };
        // Captura rejeições de Promises não tratadas
        window.onunhandledrejection = function(event) {
             logOnScreen(`ERRO PROMISE: ${event.reason}`);
             console.error(event);
        };
        // ---------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            logOnScreen("Home: DOMContentLoaded iniciado."); // LOG INICIAL

            const isLoggedIn = localStorage.getItem('duckflix_isLoggedIn') === 'true';
            const loadingIndicator = document.getElementById('loading-indicator');
            const catalogContent = document.getElementById('catalog-content');
            const logoutButton = document.getElementById('logout-button');

            logOnScreen(`Home: Verificando login. Status: ${isLoggedIn}`);

            if (!isLoggedIn) {
                logOnScreen("Home: Não logado. Redirecionando para index.html");
                window.location.replace('index.html');
                return;
            }

            loadingIndicator.classList.add('hidden');
            catalogContent.classList.remove('hidden');
            logoutButton.classList.remove('hidden');
            logOnScreen("Home: Logado. Iniciando carregamento do catálogo...");

            // --- REFERÊNCIAS ---
            const listaUrl = 'lista.json';
            const catalogMain = document.getElementById('catalog-main');
            let allItems = [];
            let focusableElements = [];
            let currentFocusIndex = 0;

            // --- LÓGICA DE LOGOUT ---
             logoutButton.addEventListener('click', () => {
                 logOnScreen("Home: Botão Sair clicado.");
                localStorage.removeItem('duckflix_isLoggedIn');
                window.location.replace('index.html');
            });

            // --- LÓGICA DO CATÁLOGO ---
            function fetchLista() {
                 logOnScreen("Home: Iniciando fetchLista()...");
                if (catalogMain.querySelector('.movie-section')) {
                     logOnScreen("Home: Catálogo já existe, reativando navegação.");
                     setupNavigation();
                     return;
                }

                fetch(listaUrl)
                    .then(response => {
                        logOnScreen(`Home: Fetch status: ${response.status}`);
                        if (!response.ok) throw new Error(`Erro HTTP! status: ${response.status} ao buscar ${listaUrl}`);
                        return response.json();
                    })
                    .then(data => {
                        logOnScreen("Home: lista.json carregado e parseado com sucesso.");
                        catalogMain.innerHTML = '';
                        allItems = [];

                        if (!data || !Array.isArray(data.categorias)) {
                             throw new Error("Formato inválido do lista.json.");
                        }

                        // Coleta itens
                        data.categorias.forEach(cat => {
                            if (cat && Array.isArray(cat.items)) {
                                cat.items.forEach(item => {
                                     if(item && !item.id) item.id = (item.titulo || 'item').replace(/\s+/g, '').toLowerCase() + (item.ano || '');
                                     if(item) allItems.push(item);
                                });
                            } else { logOnScreen("WARN: Categoria inválida encontrada."); }
                        });
                        logOnScreen(`Home: Total de ${allItems.length} itens coletados.`);

                        // Cria seções (incluindo "Continuar Assistindo")
                        createContinueWatchingSection();
                        data.categorias.forEach(categoria => {
                             // (Código para criar seções e grades - igual anterior)
                             if (!categoria || !Array.isArray(categoria.items)) return;
                             const section = document.createElement('section'); section.className = 'movie-section';
                             const title = document.createElement('h2'); title.textContent = categoria.titulo || 'Categoria'; section.appendChild(title);
                             const grid = document.createElement('div'); grid.className = 'movie-grid';
                             categoria.items.forEach(item => {
                                if (!item) return;
                                const cardLink = createMovieCard(item);
                                cardLink.classList.add('focusable');
                                grid.appendChild(cardLink);
                             });
                             section.appendChild(grid); catalogMain.appendChild(section);
                        });

                        logOnScreen("Home: HTML do catálogo construído.");
                        setupNavigation(); // Configura navegação
                    })
                    .catch(error => {
                        // **MOSTRA O ERRO NA TELA**
                        logOnScreen(`ERRO fetchLista: ${error.message}`);
                        console.error('Home: Erro CRÍTICO fetchLista:', error);
                        catalogMain.innerHTML = `<h2>Erro ao carregar: ${error.message}</h2>`;
                    });
            } // Fim fetchLista

            // Chama o carregamento
            fetchLista();

            // (Funções createMovieCard, createContinueWatchingSection, setupNavigation e handleKeyDown - iguais à versão anterior)
            // Certifique-se de que elas também usam logOnScreen() para mensagens importantes ou erros.
             function createMovieCard(item, savedTime = 0) { /* ... (código igual) ... */ return cardLink; }
             function createContinueWatchingSection() { /* ... (código igual, usar logOnScreen) ... */ }
             function setupNavigation() { /* ... (código igual, usar logOnScreen) ... */ }
             function handleKeyDown(event) { /* ... (código igual) ... */ }


        }); // Fim do DOMContentLoaded
    </script>
    <script src="cordova.js"></script>
    <script src="js/app.js"></script>
</body>
</html>
